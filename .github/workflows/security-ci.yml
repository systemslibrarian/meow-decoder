name: Security CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read

jobs:
  security:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libzbar0 libgl1 libglib2.0-0 \
            build-essential pkg-config libssl-dev

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install -e .

      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      # ✅ Build wheel (does NOT require venv), then install it
      - name: Build + install Rust crypto backend (maturin build)
        run: |
          python -m pip install maturin
          cd rust_crypto
          maturin build --release --out dist
          python -m pip install dist/*.whl
          cd ..

      # Optional: verify import (adjust module name if needed)
      - name: Verify Rust backend import
        run: |
          python - << 'EOF'
          try:
              import meow_crypto_rs
              print("✅ Rust backend import OK")
          except Exception as e:
              print("❌ Rust backend import failed:", e)
              raise
          EOF

      - name: Security-focused tests (required)
        run: |
          pytest tests/test_security.py tests/test_adversarial.py -v
        env:
          MEOW_TEST_MODE: "1"
          MEOW_CRYPTO_BACKEND: "rust"

  # ===========================================================================
  # CRIT-01: Verify PQ crypto is NOT in default features
  # Post-quantum crates are experimental (v0.1.0-rc). Accidental inclusion
  # in default features could expose users to unaudited code.
  # See: CRYPTO_SECURITY_REVIEW.md § CRIT-01
  # ===========================================================================
  pq-feature-gate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install toml parser
        run: pip install toml

      - name: Verify pq-crypto NOT in default features
        run: |
          python << 'EOF'
          import toml
          import sys

          # Parse Cargo.toml
          cargo = toml.load("crypto_core/Cargo.toml")
          features = cargo.get("features", {})
          default = features.get("default", [])

          # Check direct inclusion
          if "pq-crypto" in default:
              print("❌ SECURITY VIOLATION: pq-crypto is in default features!")
              print("   Post-quantum crates are experimental (v0.1.0-rc).")
              print("   Remove from default features or document the risk.")
              sys.exit(1)

          # Check transitive inclusion via meta-features
          def get_transitive_features(feature_name, seen=None):
              if seen is None:
                  seen = set()
              if feature_name in seen:
                  return set()
              seen.add(feature_name)
              result = {feature_name}
              for dep in features.get(feature_name, []):
                  if not dep.startswith("dep:"):  # Skip dep: syntax
                      result.update(get_transitive_features(dep, seen))
              return result

          all_default = set()
          for f in default:
              all_default.update(get_transitive_features(f))

          if "pq-crypto" in all_default:
              print("❌ SECURITY VIOLATION: pq-crypto is transitively enabled by default!")
              print(f"   Transitive chain: {default} -> ... -> pq-crypto")
              sys.exit(1)

          print("✅ PQ feature gate check passed")
          print(f"   Default features: {default}")
          print(f"   pq-crypto: NOT in default (correct)")
          EOF
