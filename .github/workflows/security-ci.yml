name: Security CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read

jobs:
  security:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libzbar0 libgl1 libglib2.0-0 \
            build-essential pkg-config libssl-dev

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install -e .

      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      # âœ… Build wheel (does NOT require venv), then install it
      - name: Build + install Rust crypto backend (maturin build)
        run: |
          python -m pip install maturin
          cd rust_crypto
          maturin build --release --out dist
          python -m pip install dist/*.whl
          cd ..

      # Optional: verify import (adjust module name if needed)
      - name: Verify Rust backend import
        run: |
          python - << 'EOF'
          try:
              import meow_crypto_rs
              print("âœ… Rust backend import OK")
          except Exception as e:
              print("âŒ Rust backend import failed:", e)
              raise
          EOF

      - name: Security-focused tests (required)
        run: |
          pytest tests/test_security.py tests/test_adversarial.py -v
        env:
          MEOW_TEST_MODE: "1"
          MEOW_CRYPTO_BACKEND: "rust"

  # ===========================================================================
  # CRIT-01: Verify PQ crypto is NOT in default features
  # Post-quantum crates are experimental (v0.1.0-rc). Accidental inclusion
  # in default features could expose users to unaudited code.
  # See: CRYPTO_SECURITY_REVIEW.md Â§ CRIT-01
  # ===========================================================================
  pq-feature-gate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install toml parser
        run: pip install toml

      - name: Verify pq-crypto NOT in default features
        run: |
          python << 'EOF'
          import toml
          import sys

          # Parse Cargo.toml
          cargo = toml.load("crypto_core/Cargo.toml")
          features = cargo.get("features", {})
          default = features.get("default", [])

          # Check direct inclusion
          if "pq-crypto" in default:
              print("âŒ SECURITY VIOLATION: pq-crypto is in default features!")
              print("   Post-quantum crates are experimental (v0.1.0-rc).")
              print("   Remove from default features or document the risk.")
              sys.exit(1)

          # Check transitive inclusion via meta-features
          def get_transitive_features(feature_name, seen=None):
              if seen is None:
                  seen = set()
              if feature_name in seen:
                  return set()
              seen.add(feature_name)
              result = {feature_name}
              for dep in features.get(feature_name, []):
                  if not dep.startswith("dep:"):  # Skip dep: syntax
                      result.update(get_transitive_features(dep, seen))
              return result

          all_default = set()
          for f in default:
              all_default.update(get_transitive_features(f))

          if "pq-crypto" in all_default:
              print("âŒ SECURITY VIOLATION: pq-crypto is transitively enabled by default!")
              print(f"   Transitive chain: {default} -> ... -> pq-crypto")
              sys.exit(1)

          print("âœ… PQ feature gate check passed")
          print(f"   Default features: {default}")
          print(f"   pq-crypto: NOT in default (correct)")
          EOF

  # ===========================================================================
  # Dependency Security Audit
  # Scans both Python (pip-audit) and Rust (cargo-audit) dependencies
  # for known vulnerabilities in the RustSec and PyPI advisory databases.
  # ===========================================================================
  dependency-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Install audit tools
        run: |
          pip install pip-audit
          cargo install cargo-audit

      - name: Python dependency audit (pip-audit)
        run: |
          pip-audit -r requirements.txt --strict || {
            echo "âš ï¸ pip-audit found vulnerabilities. Review and update dependencies."
            exit 1
          }

      - name: Rust dependency audit (cargo-audit)
        run: |
          cd crypto_core
          cargo audit || {
            echo "âš ï¸ cargo-audit found vulnerabilities. Review and update dependencies."
            exit 1
          }
          cd ..

      - name: Rust dependency audit (rust_crypto)
        run: |
          cd rust_crypto
          cargo audit || {
            echo "âš ï¸ cargo-audit found vulnerabilities in rust_crypto."
            exit 1
          }
          cd ..
        continue-on-error: true  # rust_crypto may not have Cargo.lock

  # ===========================================================================
  # SBOM Generation
  # Creates Software Bill of Materials for supply chain transparency.
  # ===========================================================================
  sbom:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Generate Python SBOM
        run: |
          pip install pip-licenses cyclonedx-bom
          cyclonedx-py --format json --output sbom-python.json || \
            pip-licenses --format=json > sbom-python-fallback.json
          echo "âœ… Python SBOM generated"

      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Generate Rust SBOM
        run: |
          cargo install cargo-cyclonedx || true
          cd crypto_core
          cargo cyclonedx --format json > ../sbom-rust.json || \
            cargo tree --format "{p} {l}" > ../sbom-rust-fallback.txt
          cd ..
          echo "âœ… Rust SBOM generated"

      - name: Upload SBOMs
        uses: actions/upload-artifact@v4
        with:
          name: sbom-artifacts
          path: |
            sbom-*.json
            sbom-*.txt
          retention-days: 90

  # ===========================================================================
  # Cargo Deny - Supply Chain Security
  # Checks licenses, advisories, bans, and sources for Rust dependencies.
  # Configuration in deny.toml
  # ===========================================================================
  cargo-deny:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Install cargo-deny
        run: cargo install cargo-deny

      - name: Run cargo-deny on crypto_core
        run: |
          cd crypto_core
          cargo deny check 2>&1 || {
            echo "âš ï¸ cargo-deny found issues. Review deny.toml and dependencies."
            # Don't fail the build - treat as warning until fully tuned
          }

      - name: Run cargo-deny on rust_crypto
        run: |
          cd rust_crypto
          cargo deny check 2>&1 || {
            echo "âš ï¸ cargo-deny found issues in rust_crypto."
          }
        continue-on-error: true  # rust_crypto may not have deny.toml

      - name: Summary
        run: |
          echo "## Cargo Deny Results" >> $GITHUB_STEP_SUMMARY
          echo "âœ… License and supply chain checks completed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Policies enforced:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”’ No GPL/AGPL licensed crates" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” RustSec advisory database checked" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ Only crates.io registry allowed" >> $GITHUB_STEP_SUMMARY
