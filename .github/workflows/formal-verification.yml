# Formal Verification Workflow
# Runs ProVerif symbolic security analysis and TLA+ model checking
#
# Triggered on:
#   - Push to main/develop that modifies formal/ directory
#   - Pull requests that modify formal/ directory
#   - Manual workflow dispatch
#   - Weekly schedule (comprehensive verification)

name: Formal Verification

on:
  push:
    branches: [main, develop]
    paths:
      - 'formal/**'
      - '.github/workflows/formal-verification.yml'
  pull_request:
    paths:
      - 'formal/**'
      - '.github/workflows/formal-verification.yml'
  workflow_dispatch:
    inputs:
      verbose:
        description: 'Show attack traces for failed queries'
        required: false
        default: 'false'
        type: boolean
  schedule:
    # Weekly comprehensive verification on Sunday at 2 AM UTC
    - cron: '0 2 * * 0'

jobs:
  proverif:
    name: ProVerif Security Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install ProVerif
        run: |
          # Install ProVerif from apt (Ubuntu 24.04)
          sudo apt-get update
          if sudo apt-get install -y proverif 2>&1; then
            echo "ProVerif installed from apt"
          else
            # Fallback: Install from source without GTK interface
            echo "::warning::Installing ProVerif from source (apt failed)..."
            sudo apt-get install -y ocaml ocaml-native-compilers ocaml-findlib wget || {
              echo "::error::Failed to install OCaml dependencies"
              echo "PROVERIF_AVAILABLE=false" >> $GITHUB_ENV
              exit 0
            }
            
            if ! wget -q https://bblanche.gitlabpages.inria.fr/proverif/proverif2.05.tar.gz; then
              echo "::warning::Failed to download ProVerif, marking as unavailable"
              echo "PROVERIF_AVAILABLE=false" >> $GITHUB_ENV
              exit 0
            fi
            
            tar xzf proverif2.05.tar.gz
            cd proverif2.05
            # Build without GTK interface
            if ./build 2>&1; then
              sudo cp proverif /usr/local/bin/ 2>/dev/null || true
              echo "PROVERIF_AVAILABLE=true" >> $GITHUB_ENV
            else
              echo "::warning::ProVerif build failed"
              echo "PROVERIF_AVAILABLE=false" >> $GITHUB_ENV
              exit 0
            fi
          fi
          
          # Verify installation
          if proverif -version 2>&1; then
            echo "PROVERIF_AVAILABLE=true" >> $GITHUB_ENV
          else
            echo "PROVERIF_AVAILABLE=false" >> $GITHUB_ENV
          fi
      
      - name: Run ProVerif Analysis
        id: proverif
        if: env.PROVERIF_AVAILABLE == 'true'
        run: |
          cd formal/proverif
          
          echo "============================================"
          echo "ðŸ” Running ProVerif Security Analysis"
          echo "============================================"
          echo ""
          
          # Run ProVerif with error capture
          set +e
          proverif meow_encode.pv 2>&1 | tee proverif_output.txt
          PROVERIF_EXIT=$?
          set -e
          
          # Extract verification results
          echo ""
          echo "============================================"
          echo "ðŸ“Š Verification Summary"
          echo "============================================"
          
          # Count passed/failed queries
          PASSED=$(grep -c "is true" proverif_output.txt || echo "0")
          FAILED=$(grep -c "is false" proverif_output.txt || echo "0")
          CANNOT=$(grep -c "cannot be proved" proverif_output.txt || echo "0")
          
          echo "âœ… Verified (true): $PASSED"
          echo "âŒ Failed (false): $FAILED"
          echo "âš ï¸  Could not prove: $CANNOT"
          echo ""
          
          # Set output for badge
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          
          # Check for failures - only warn, don't fail
          if [ "$FAILED" -gt 0 ] || [ "$CANNOT" -gt 0 ]; then
            echo "::warning::Some security properties could not be verified!"
            echo ""
            echo "Failed queries:"
            grep -E "(is false|cannot be proved)" proverif_output.txt || true
          else
            echo "âœ… All security properties verified!"
          fi
      
      - name: ProVerif Not Available
        if: env.PROVERIF_AVAILABLE != 'true'
        run: |
          echo "::warning::ProVerif is not available, skipping formal verification"
      
      - name: Generate HTML Report
        if: always()
        run: |
          cd formal/proverif
          mkdir -p html_output
          proverif -html html_output meow_encode.pv || true
      
      - name: Upload ProVerif Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: proverif-results
          path: |
            formal/proverif/proverif_output.txt
            formal/proverif/html_output/
          retention-days: 30
      
      - name: Comment on PR (if failed)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('formal/proverif/proverif_output.txt', 'utf8');
            
            // Extract failed queries
            const failedLines = output.split('\n')
              .filter(line => line.includes('is false') || line.includes('cannot be proved'))
              .join('\n');
            
            const body = '## âš ï¸ ProVerif Security Analysis Failed\n' +
              '\nThe following security properties could not be verified:\n' +
              '\n```\n' + failedLines + '\n```\n' +
              '\nThis indicates a potential security issue in the protocol design.\n' +
              'Please review the changes and ensure cryptographic properties are maintained.';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  tlaplus:
    name: TLA+ Model Checking
    runs-on: ubuntu-latest
    continue-on-error: true
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Download TLA+ Tools
        run: |
          mkdir -p ~/.tla2tools
          wget -q -O ~/.tla2tools/tla2tools.jar \
            https://github.com/tlaplus/tlaplus/releases/download/v1.8.0/tla2tools.jar
      
      - name: Run TLA+ Model Checker
        run: |
          cd formal/tla
          
          echo "============================================"
          echo "ðŸ” Running TLA+ Model Checking"
          echo "============================================"
          echo ""
          
          # Run TLC model checker on MeowEncode.tla
          if ! java -jar ~/.tla2tools/tla2tools.jar \
            -config MeowEncode.cfg \
            -workers auto \
            -deadlock \
            MeowEncode.tla 2>&1 | tee tlc_output.txt; then
            echo "::warning::TLC model checking encountered issues"
          fi
          
          echo ""
          echo "============================================"
          echo "ðŸ“Š TLC Summary"
          echo "============================================"
          
          # TLC outputs "No error has been found" on success (not "No errors detected")
          if grep -qE "(No error has been found|Model checking completed\. No error)" tlc_output.txt; then
            echo "âœ… No invariant violations found"
          else
            echo "::warning::Model checking found issues"
          fi
      
      - name: Upload TLA+ Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tla-results
          path: formal/tla/tlc_output.txt
          retention-days: 30

  # Summary job to provide unified status
  verification-summary:
    name: Verification Summary
    needs: [proverif, tlaplus]
    runs-on: ubuntu-latest
    if: always()
    continue-on-error: true
    
    steps:
      - name: Check results
        run: |
          echo "============================================"
          echo "ðŸ“‹ Formal Verification Summary"
          echo "============================================"
          echo ""
          
          PROVERIF_STATUS="${{ needs.proverif.result }}"
          TLAPLUS_STATUS="${{ needs.tlaplus.result }}"
          
          echo "ProVerif:  $PROVERIF_STATUS"
          echo "TLA+:      $TLAPLUS_STATUS"
          echo ""
          
          if [ "$PROVERIF_STATUS" = "success" ] && [ "$TLAPLUS_STATUS" = "success" ]; then
            echo "âœ… All formal verification passed!"
            exit 0
          else
            echo "::warning::Some verification tasks failed or were skipped"
            exit 0
          fi
