name: Fuzzing

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run fuzzing weekly on Sundays at midnight
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      fuzz_duration:
        description: 'Fuzzing duration in seconds'
        required: false
        default: '300'

jobs:
  atheris-fuzz:
    name: Python Fuzzing (Atheris)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install atheris
          # Install zbar for QR decoding
          sudo apt-get update
          sudo apt-get install -y libzbar0 libgl1 libglib2.0-0
          pip install -r requirements.txt
          pip install -r requirements-dev.txt || true
          pip install -e .
      
      - name: Create corpus directories
        run: |
          mkdir -p fuzz/corpus/manifest
          mkdir -p fuzz/corpus/qr
          mkdir -p fuzz/corpus/fountain
          mkdir -p fuzz/crashes
      
      - name: Seed corpus with valid samples
        run: |
          python fuzz/seed_corpus.py
      
      - name: Fuzz manifest parser
        run: |
          timeout ${{ github.event.inputs.fuzz_duration || '60' }}s \
            python fuzz/fuzz_manifest.py fuzz/corpus/manifest || true
        continue-on-error: true
      
      - name: Fuzz fountain decoder
        run: |
          timeout ${{ github.event.inputs.fuzz_duration || '60' }}s \
            python fuzz/fuzz_fountain.py fuzz/corpus/fountain || true
        continue-on-error: true
      
      - name: Fuzz crypto operations
        run: |
          timeout ${{ github.event.inputs.fuzz_duration || '60' }}s \
            python fuzz/fuzz_crypto.py fuzz/corpus/manifest || true
        continue-on-error: true
      
      - name: Check for crashes
        run: |
          if [ -n "$(ls -A fuzz/crashes 2>/dev/null)" ]; then
            echo "ðŸš¨ Crashes found!"
            ls -la fuzz/crashes/
            exit 1
          else
            echo "âœ… No crashes found"
          fi
      
      - name: Upload crash artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-crashes
          path: fuzz/crashes/
          retention-days: 30

  afl-fuzz:
    name: AFL++ Fuzzing (Native)
    runs-on: ubuntu-latest
    timeout-minutes: 60
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install AFL++
        run: |
          sudo apt-get update
          sudo apt-get install -y afl++ || echo "AFL++ installation skipped"
          sudo apt-get update
          sudo apt-get install -y afl++ python3-dev
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install -e ".[dev]"
          pip install python-afl
          sudo apt-get install -y libzbar0
      
      - name: Create corpus
        run: |
          mkdir -p fuzz/afl-corpus
          mkdir -p fuzz/afl-output
          python fuzz/seed_corpus.py --afl
      
      - name: Run AFL++ on manifest parser
        run: |
          cd fuzz
          timeout ${{ github.event.inputs.fuzz_duration || '300' }}s \
            py-afl-fuzz -i afl-corpus -o afl-output -m none -- \
            python afl_fuzz_manifest.py || true
        continue-on-error: true
      
      - name: Check AFL++ results
        run: |
          if [ -d "fuzz/afl-output/default/crashes" ] && [ -n "$(ls -A fuzz/afl-output/default/crashes 2>/dev/null)" ]; then
            echo "ðŸš¨ AFL++ found crashes!"
            ls -la fuzz/afl-output/default/crashes/
            exit 1
          else
            echo "âœ… No AFL++ crashes found"
          fi
      
      - name: Upload AFL++ results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: afl-results
          path: fuzz/afl-output/
          retention-days: 7
